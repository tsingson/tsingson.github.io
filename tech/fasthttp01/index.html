<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="tsingson"/>

  
  <meta name="description" content="fasthttp系列文章"/>
  

  
  
  <meta name="keywords" content="tsingson, gdihf, music, harmonica, blues"/>
  

  
  <link rel="canonical" href="/tech/fasthttp01/"/>

  

  <title>fasthttp系列文章(01) &middot; 技术.设计.音乐--带来价值与欢乐的三明智</title>

  <link rel="shortcut icon" href="/images/favicon.ico"/>
  <link rel="stylesheet" href="/css/animate.min.css"/>
  <link rel="stylesheet" href="/css/remixicon.css"/>
  <link rel="stylesheet" href="/css/zozo.css"/>
  <link rel="stylesheet" href="/css/highlight.css"/>

  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "fasthttp系列文章(01)",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/tech\/fasthttp01\/"
        },
    
    "genre": "tech",
    "keywords": "programming, golang",
    "wordcount":  2004 ,
    "url": "\/tech\/fasthttp01\/",
    "datePublished": "2019-08-02T02:02:57\x2b08:00",
    "dateModified": "2019-08-02T02:02:57\x2b08:00",
    
    
    "author": {
    "@type": "Person",
    "name": "tsingson"
    },
    "description": "fasthttp系列文章"
    }
</script>

</head>

<body>
<div class="main animated">
    <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">首页</a>
      </li>
      
      <li>
        <a href="/tech/">技术</a>
      </li>
      
      <li>
        <a href="/photography/">摄影</a>
      </li>
      
      <li>
        <a href="/design/">设计</a>
      </li>
      
      <li>
        <a href="/music/">音乐</a>
      </li>
      
      <li>
        <a href="/tags/">Tags</a>
      </li>
      
      <li>
        <a href="/about/about-me/">关于</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

    <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="/">

          <img src="/images/logo.svg" width=150px/>   <span>技术.设计.音乐--带来价值与欢乐的三明智</span>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">programming.design.music</p>
      <div class="my_socials">
        
        
        <a href="https://github.com/tsingson" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="https://twitter.com/tsingson" title="twitter" target="_blank"><i class="remixicon-twitter-fill"></i></a>
        
        
        <a href="/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

    <div class="content">
        <div class="post_page">
            <div class="post animated fadeInDown">
                <div class="post_title post_detail_title">
                    <h2><a href='/tech/fasthttp01/'>fasthttp系列文章(01)</a></h2>
                    <span class="date">2019-08-02</span>
                </div>
                <div class="post_content markdown"><p><img src="/tech/assets/photo-desk.jpg" alt="photo-desk" /></p>

<blockquote>
<p>fasthttp 文章系列:
*  fasthttp web client 客户端(本文)
*  fasthttp web server 服务端(及路由)
*  fasthttp web server 中间件( 简单认证/ uber-go的zap日志/session会话...)
*  fasthttp RESTful (处理JSON数据)
*  fasthttp 处理 JWT (及 JWT安全性)
*  fasthttp 对接非标准 web client (作为AAA, 数据加解密)
*  fasthttp 部署</p>
</blockquote>

<p>[简述]  <a href="https://github.com/valyala/fasthttp">github.com/valyala/fasthttp</a> 是 golang 中一个标志性的高性能 HTTP库, 主要用于 webserver 开发, 以及 web client / proxy 等. fasthttp 的高性能开发思路, 启发了很多开发者.</p>

<p>fasthttp 自己的介绍如下:</p>

<blockquote>
<p>Fast HTTP package for Go. Tuned for high performance. Zero memory allocations in hot paths. Up to 10x faster than net/http</p>

<p>Fast HTTP implementation for Go.</p>

<p>Currently fasthttp is successfully used by <a href="https://vertamedia.com/">VertaMedia</a>
in a production serving up to 200K rps from more than 1.5M concurrent keep-alive
connections per physical server.</p>
</blockquote>

<p>事实上, 这有点小夸张, 但在一定场景下经过优化部署, 确是有很高的性能.</p>

<p>近3年来, fasthttp 被我用在几个重大项目(对我而言, 项目有多重大, 与收钱的多少成正比) 中, 这里, 就写一个小系列, 介绍 fasthttp 的实际使用与经验得失.</p>

<blockquote>
<hr />

<p>想直接看代码的朋友, 请访问 <a href="https://github.com/tsingson/fasthttp-example">我写的 fasthttp-example</a></p>

<hr />
</blockquote>

<h2 id="0-关于-fasthttp-的优点介绍">0. 关于 fasthttp 的优点介绍</h2>

<p>以下文字来自 <a href="https://my.oschina.net/fuxiaohei">傅小黑</a> 原创文章: <a href="https://my.oschina.net/fuxiaohei/blog/753977">Go 开发 HTTP 的另一个选择 fasthttp</a> 写于2016/09/30 :</p>

<blockquote>
<p>fasthttp 是 Go 的一款不同于标准库 net/http 的 HTTP 实现。fasthttp 的性能可以达到标准库的 10 倍，说明他魔性的实现方式。主要的点在于四个方面：</p>

<ul>
<li>net/http 的实现是一个连接新建一个 goroutine；fasthttp 是利用一个 worker 复用 goroutine，减轻 runtime 调度 goroutine 的压力</li>
<li>net/http 解析的请求数据很多放在 map[string]string(http.Header) 或 map[string][]string(http.Request.Form)，有不必要的 []byte 到 string 的转换，是可以规避的</li>
<li>net/http 解析 HTTP 请求每次生成新的 *http.Request 和 http.ResponseWriter; fasthttp 解析 HTTP 数据到 *fasthttp.RequestCtx，然后使用 sync.Pool 复用结构实例，减少对象的数量</li>
<li>fasthttp 会延迟解析 HTTP 请求中的数据，尤其是 Body 部分。这样节省了很多不直接操作 Body 的情况的消耗</li>
</ul>

<p>但是因为 fasthttp 的实现与标准库差距较大，所以 API 的设计完全不同。使用时既需要理解 HTTP 的处理过程，又需要注意和标准库的差别。</p>
</blockquote>

<p>这段文字非常精练的总结了 fasthttp 的特点, 我摘录了这部分放在这里, 感谢 <a href="https://my.oschina.net/fuxiaohei">傅小黑</a>  --- 另外, <a href="https://my.oschina.net/fuxiaohei">傅小黑</a> 的技术文章非常棒, 欢迎大家去围观他....</p>

<h2 id="1-从-http-1-x-协议说起">1. 从 HTTP 1.x 协议说起</h2>

<blockquote>
<p>想要使用 fasthttp 的朋友, 请尽量对 http 1.x 协议要很熟悉, 很熟悉.</p>
</blockquote>

<h4 id="1-1-http-1-x-协议简述">1.1 HTTP 1.x 协议简述</h4>

<p>简单来说, HTTP 1.x 协议, 是一个被动式短连接的 client (请求 request )  - server ( 响应 response) 交互的规范:</p>

<ol>
<li><p>协议一般来说, 以 TCP 通讯协议为基础 ( 不谈 QUIC 这个以 udp 为底层实现的变异)</p>

<blockquote>
<p>web client 通过 DNS 把域名转换成 IP 地址后, 与 web server 握手连接, 连接成功后, web client 客户端向 web server 服务端发出请求, 服务端收到请求后, 向 client 客户端应答</p>
</blockquote></li>

<li><p>通过 URL / URI 进行导址, 同时, URL/URI 中包含部分数据
&gt; URL 形式如 <a href="http://192.168.1.1:8088/rpc/schedule">http://192.168.1.1:8088/rpc/schedule</a>
&gt; 其中 <a href="http://192.168.1.1:8080">http://192.168.1.1:8080</a>  这部分是通讯协议, 服务器 IP 地址与端口号, 这是前面 TCP 通讯的依据
&gt; 1.  web 服务器端在 <a href="http://192.168.1.1:8080">http://192.168.1.1:8080</a> 这个地址上监听, 随时准备接收 web client 请求并应答
&gt; 1.  web 客户端通过 <a href="http://192.168.1.1:8080">http://192.168.1.1:8080</a> 这个地址所指定的 web 服务器进行 tcp 连接, 连接成功后, web 客户端向服务器发出 请求数据, web 服务端应答 响应数据
&gt; 1.  特别注意, 请求数据, 与响应数据, 遵从 HTTP 协议规定的统一格式</p></li>

<li><p>在 HTTP 1.x 协议中规定的传输( 请求/应答) 数据格式, 一般称为 HyperText, 是一种文本数据格式,  当然了, 在 TCP 传输时还是二进制数据块 ( 这是使用 fasthttp 的关键点) . 具体数据格式见 1.2 小节</p></li>

<li><p>HTTP 协议规定了一些信令, 如下描述, 来区分不同的交互操作
&gt; 根据HTTP标准，HTTP请求可以使用多种请求方法:
&gt;
&gt; * HTTP1.0定义了三种请求方法： GET, POST 和 HEAD方法。
&gt; * HTTP1.1新增了五种请求方法：OPTIONS, PUT, DELETE, TRACE 和 CONNECT 方法。</p></li>

<li><p>由于 HTTP 协议相关的 MIME 规范, HTTP 1.x 也可以传输图像/音乐/视频等其他数据格式,但这些被传输的真正有效数据都被封装在 http payload 这一部分里, http header 还保留( 只是字段多少, 以及字段中的值不同)  ---------<strong>这是另一个与 fasthttp 关联的另一个要点</strong></p></li>
</ol>

<h3 id="1-2-http-1-x-中的请求-响应共同遵从的数据格式">1.2 HTTP 1.x 中的请求/响应共同遵从的数据格式</h3>

<p>下面看一个 POST 请求</p>

<p><img src="https://user-gold-cdn.xitu.io/2019/8/3/16c53a4bbef1495a?w=1512&amp;h=1300&amp;f=png&amp;s=229637" alt="" /></p>

<p><img src="https://user-gold-cdn.xitu.io/2019/8/3/16c53a4eddef1a43?w=2290&amp;h=1170&amp;f=png&amp;s=215294" alt="" /></p>

<p>请求数据如下, 响应是一样的格式.
在下面的数据中:</p>

<pre><code>1. 在下面的数据格式中, 特别注意, 中间有一个空行
1. 空行上半部分, 叫 http header , 下半部分, 叫 http payload 或叫 http body
1. 在上半部分的 http header 中, 请注意第1,2行
1. 请对比一下, 下方同时列出的 GET 请求数据
</code></pre>

<hr />

<p>POST 请求数据示例</p>

<pre><code>POST /rpc/schedule HTTP/1.1
Host: 192.168.1.1:3001
Content-Type: application/json
Accept: application/vnd.pgrst.object+json
User-Agent: PostmanRuntime/7.15.2
Host: 192.168.1.1:3001
Accept-Encoding: gzip, deflate
Content-Length: 208
Connection: keep-alive

{
  &quot;actual_start_date&quot;: &quot;2019-07-29&quot;,
  &quot;actual_end_date&quot;: &quot;2019-07-29&quot;,
  &quot;plan_start_date&quot;: &quot;2019-07-29&quot;,
  &quot;plan_end_date&quot;: &quot;2019-02-12&quot;,
  &quot;title&quot;: &quot;00002&quot;,
  &quot;user_id&quot;: 2098735545843717147
}
</code></pre>

<hr />

<p>GET 请求示例</p>

<pre><code>GET /schedule?user_id=eq.2098735545843717147 HTTP/1.1
Host: 192.168.1.1:3001
Content-Type: application/json
User-Agent: PostmanRuntime/7.15.2
Accept: */*
Host: 192.168.1.1:3001
Accept-Encoding: gzip, deflate
Content-Length: 208
Connection: keep-alive

{
  &quot;actual_start_date&quot;: &quot;2019-07-29&quot;,
  &quot;actual_end_date&quot;: &quot;2019-07-29&quot;,
  &quot;plan_start_date&quot;: &quot;2019-07-29&quot;,
  &quot;plan_end_date&quot;: &quot;2019-02-12&quot;,
  &quot;title&quot;: &quot;00002&quot;,
  &quot;user_id&quot;: 2098735545843717147
}
</code></pre>

<h3 id="1-3-小结">1.3 小结</h3>

<p>几个基础点:</p>

<ol>
<li>请求与响应的格式, 数据数据的格式是一样的
&gt; 特别注意请求数据中的第一行,第二行
&gt; 特别注意 HTTP header 与 HTTP payload 的那空行分隔</li>
<li>注意 URL/URI 中也包含有数据, 换个话说,在 <a href="http://192.168.1.1:3001/schedule?user_id=eq.2098735545843717147">http://192.168.1.1:3001/schedule?user_id=eq.2098735545843717147</a> 中, 其他部分 <strong>/schedule?user_id=eq.2098735545843717147</strong> 看做请求数据的一部分</li>
</ol>

<p>好, HTTP 1.x 就简述到这了, 后面<strong>会大量引用到这一章节说的内容</strong>.</p>

<h2 id="2-fasthttp-非-标准-的争议-及为什么选择fasthttp">2. fasthttp 非&quot;标准&quot;的争议, 及为什么选择fasthttp</h2>

<h2 id="3-fasthttp-中的两种类型web-client">3. fasthttp 中的两种类型web client</h2>

<h2 id="4-fasthttp-客户端实践">4. fasthttp 客户端实践</h2>

<h2 id="5-小结">5. 小结</h2>

<p>_</p>

<h3 id="关于我">关于我</h3>

<p>网名 tsingson (三明智, 江湖人称3爷)</p>

<p>原 ustarcom IPTV/OTT 事业部播控产品线技术架构湿/解决方案工程湿角色(8年), 自由职业者,</p>

<p>喜欢音乐(口琴,是第三/四/五届广东国际口琴嘉年华的主策划人之一), 摄影与越野,</p>

<p>喜欢 golang 语言 (商用项目中主要用 postgres + golang )</p>

<p>_</p>

<p>_
 <a href="https://github.com/tsingson">tsingson</a> 写于中国深圳 <a href="https://tsingson.github.io/music/about-studio/">小罗号口琴音乐中心</a>,   2019/08/02</p></div>
                <div class="post_footer">
                    
                    <div class="meta">
                        <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="/tags/programming/">programming</a>
                  
                <a href="/tags/golang/">golang</a>
                  
              </span>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <br>
    <br>
    <span>技术.设计.音乐</span>
  </div>
</footer>



<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/zozo.js"></script>
<script src="/js/highlight.pack.js"></script>
<link  href="/css/fancybox.min.css" rel="stylesheet">
<script src="/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>