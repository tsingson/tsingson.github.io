<!DOCTYPE html>
<html lang="zh-cn" >
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  
  <meta name="author"
        content="tsingson"/>

  
  <meta name="description" content="goim 客户端之消息发送/接收实现解读与定制"/>
  

  
  
  <meta name="keywords" content="tsingson"/>
  

  
  <link rel="canonical" href="/tech/goim-go-05/"/>

  

  <title>goim 客户端之消息发送/接收 &middot; 技术.设计.音乐--带来价值与欢乐的三明智</title>

  <link rel="shortcut icon" href="/images/favicon.ico"/>
  <link rel="stylesheet" href="/css/animate.min.css"/>
  <link rel="stylesheet" href="/css/remixicon.css"/>
  <link rel="stylesheet" href="/css/zozo.css"/>
  <link rel="stylesheet" href="/css/highlight.css"/>

  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "goim 客户端之消息发送\/接收",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/tech\/goim-go-05\/"
        },
    
    "genre": "tech",
    "keywords": "goim, golang",
    "wordcount":  1254 ,
    "url": "\/tech\/goim-go-05\/",
    "datePublished": "2019-05-24T12:02:57\x2b08:00",
    "dateModified": "2019-05-24T12:02:57\x2b08:00",
    
    
    "author": {
    "@type": "Person",
    "name": "tsingson"
    },
    "description": "goim 客户端之消息发送\/接收实现解读与定制"
    }
</script>

</head>

<body>
<div class="main animated">
    <div class="nav_container animated fadeInDown">
  <div class="site_nav" id="site_nav">
    <ul>
      
      <li>
        <a href="/">首页</a>
      </li>
      
      <li>
        <a href="/tech/">技术</a>
      </li>
      
      <li>
        <a href="/photography/">摄影</a>
      </li>
      
      <li>
        <a href="/design/">设计</a>
      </li>
      
      <li>
        <a href="/music/">音乐</a>
      </li>
      
      <li>
        <a href="/tags/">Tags</a>
      </li>
      
      <li>
        <a href="/about/about-me/">关于</a>
      </li>
      
    </ul>
  </div>
  <div class="menu_icon">
    <a id="menu_icon"><i class="remixicon-links-line"></i></a>
  </div>
</div>

    <div class="header animated fadeInDown">
  <div class="site_title_container">
    <div class="site_title">
      <h1>
        <a href="/">

          <img src="/images/logo.svg" width=150px/>   <span>技术.设计.音乐--带来价值与欢乐的三明智</span>
        </a>
      </h1>
    </div>
    <div class="description">
      <p class="sub_title">programming.design.music</p>
      <div class="my_socials">
        
        
        <a href="https://github.com/tsingson" title="github" target="_blank"><i class="remixicon-github-fill"></i></a>
        
        
        
        <a href="https://twitter.com/tsingson" title="twitter" target="_blank"><i class="remixicon-twitter-fill"></i></a>
        
        
        <a href="/index.xml" type="application/rss+xml" title="rss" target="_blank"><i class="remixicon-rss-fill"></i></a>
      </div>
    </div>
  </div>
</div>

    <div class="content">
        <div class="post_page">
            <div class="post animated fadeInDown">
                <div class="post_title post_detail_title">
                    <h2><a href='/tech/goim-go-05/'>goim 客户端之消息发送/接收</a></h2>
                    <span class="date">2019-05-24</span>
                </div>
                <div class="post_content markdown">

<blockquote>
<p>goim 文章系列:
* <a href="https://juejin.im/post/5cbb9e68e51d456e51614aab">goim 架构与定制</a>
* <a href="https://juejin.im/post/5cbd380c5188250a97133649">从goim定制, 浅谈 golang 的 interface 解耦合与gRPC</a>
* <a href="https://juejin.im/post/5cc10b086fb9a0323c526bb0">bilibili/discovery 基本概念及在 goim中的使用</a>
* <a href="https://juejin.im/post/5cd12fa16fb9a0320b40ec32">goim 的 data flow 数据流</a></p>

<p>有个 slack 频道, 不少朋友在交流 goim , 欢迎加入<a href="https://join.slack.com/t/reading-go/shared_invite/enQtMjgwNTU5MTE5NjgxLTA5NDQwYzE4NGNhNDI3N2E0ZmYwOGM2MWNjMDUyNjczY2I0OThiNzA5ZTk0MTc1MGYyYzk0NTA0MjM4OTZhYWE">slack #goim</a></p>
</blockquote>

<h3 id="0-文章撰写动机">0. 文章撰写动机</h3>

<p>goim 官网 <a href="http://goim.io">http://goim.io</a></p>

<p>goim 源码 <a href="https://github.com/Terry-Mao/goim">https://github.com/Terry-Mao/goim</a></p>

<hr />

<p>写了几个 goim 相关小文章后, 有点感慨:
&gt; goim 的文章已经很多了.
&gt; 我写了 goim 文章后就有点后悔了:
&gt;
&gt; 看到比较早的文章, 是 2016年,<a href="https://laohanlinux.github.io/2016/12/22/goim源码剖析/">goim源码剖析</a>
&gt;
&gt; 很多文章已经把 goim 说明得很清楚很明白了, 各文章作者关注点不同(版本也不同) , 有些文章非常非常好.</p>

<blockquote>
<p>从 goim 询问到的问题来看, 就两大类:</p>

<ol>
<li>阅读代码过程, 有些没看懂原始设计意图, 或对某些局部代码的使用不太清楚</li>
<li>如何实现一些业务, 包括鉴权认证啦, 消息合并啦, 离线存储或聊天机器人如何写啦, 如何部署及压测啦....</li>
</ol>

<p>我只能这样建议, 阅读代码, 阅读代码, 阅读代码, 代码说得比较清楚. ( 相比其他 im 开源库, 这是我欣赏 goim 的地方, 代码背后的设计意图一脉相承而又保持足够简单, 让 goim 成为一个优秀的 im 实现code base , 易于扩展/维护/集成...)</p>

<p>很开心的是, 因 goim 认识更多有趣的朋友, 谢谢!</p>
</blockquote>

<hr />

<p>网上很少有 goim 客户端的相关文章, 毕竟, goim 的下行客户端有 websocket javascript / java 实现例子, 上行有 http API 以及 golang 的例子.</p>

<p>这里 <a href="https://github.com/Terry-Mao/goim/issues/298">https://github.com/Terry-Mao/goim/issues/298</a> 有个issue 讨论, 还是挺有意思</p>

<p>所以, 我想, 这篇小文写写这个 goim 客户端相关的:
1. 解读一下 goim 客户端的 protocol 及 api 定义(部分只有定义, 没有相应实现代码)
2. 讨论一下 goim 的消息发布与接收相关方法
3. 讨论一下网上谈到的 goim 消息发送与接收合一的扩展</p>

<h2 id="1-goim-客户端相关的协议">1. goim 客户端相关的协议</h2>

<h3 id="1-1-数据封装-序列化与反序列化">1.1 数据封装( 序列化与反序列化)</h3>

<blockquote>
<p>Serialization and Deserialization 序列化与反序列化, 这是所有程序员即熟悉又最经常处理的一类数据操作</p>

<p><strong>序列化</strong>：把对象转换为字节序列的过程称为对象的序列化。</p>

<p><strong>反序列化</strong>：把字节序列恢复为对象的过程称为对象的反序列化。</p>
</blockquote>

<p>以下引用自 <a href="https://en.wikipedia.org/wiki/Serialization">wiki</a></p>

<blockquote>
<p>In <a href="https://en.wikipedia.org/wiki/Computer_science">computer science</a>, in the context of data storage, <strong>serialization</strong> (or serialisation) is the process of translating <a href="https://en.wikipedia.org/wiki/Data_structure">data structures</a> or <a href="https://en.wikipedia.org/wiki/Object_(computer_science)">object</a> state into a format that can be stored (for example, in a <a href="https://en.wikipedia.org/wiki/Computer_file">file</a> or memory <a href="https://en.wikipedia.org/wiki/Data_buffer">buffer</a>) or transmitted (for example, across a <a href="https://en.wikipedia.org/wiki/Computer_network">network</a> connection link) and reconstructed later (possibly in a different computer environment).[<a href="https://en.wikipedia.org/wiki/Serialization#cite_note-1">1]</a> When the resulting series of bits is reread according to the serialization format, it can be used to create a semantically identical clone of the original object. For many complex objects, such as those that make extensive use of <a href="https://en.wikipedia.org/wiki/Reference_(computer_science)">references</a>, this process is not straightforward. Serialization of object-oriented <a href="https://en.wikipedia.org/wiki/Object_(computer_science)">objects</a> does not include any of their associated <a href="https://en.wikipedia.org/wiki/Method_(computer_science)">methods</a> with which they were previously linked.</p>

<p>This process of serializing an object is also called <a href="https://en.wikipedia.org/wiki/Marshalling_(computer_science)">marshalling</a> an object.[<a href="https://en.wikipedia.org/wiki/Serialization#cite_note-2">2]</a> The opposite operation, extracting a data structure from a series of bytes, is <strong>deserialization</strong> (also called <strong>unmarshalling</strong>).</p>
</blockquote>

<p>以下是<a href="https://zh.wikipedia.org/wiki/序列化">中文wiki</a></p>

<blockquote>
<p><strong>序列化</strong>（serialization）在<a href="https://zh.wikipedia.org/wiki/計算機科學">計算機科學</a>的資料處理中，是指將<a href="https://zh.wikipedia.org/wiki/資料結構">資料結構</a>或物件狀態轉換成可取用格式（例如存成檔案，存於緩衝，或經由網絡中傳送），以留待後續在相同或另一台計算機環境中，能恢復原先狀態的過程。依照序列化格式重新獲取位元組的結果時，可以利用它來產生與原始物件相同語義的副本。對於許多物件，像是使用大量參照的複雜物件，這種序列化重建的過程並不容易。物件導向中的物件序列化，並不概括之前原始物件所關聯的函式。這種過程也稱為<strong>物件編組 （marshalling）</strong>。從一系列位元組提取資料結構的反向操作，是<strong>反序列化（也稱為解編組、deserialization、unmarshalling）</strong>。</p>
</blockquote>

<p>从上面的描述, 简单来说, 序列化与反序列化就是一个互逆的过程, 可以相互验证</p>

<h2 id="1-2-protocol-协议">1.2  protocol 协议</h2>

<p>简单来说, protocol 协议 就是一个约定, 一个共同遵守的规则</p>

<h2 id="2-goim-的-tcp-客户端编写示例">2  goim 的 TCP 客户端编写示例</h2>

<h3 id="2-1">2.1</h3>
</div>
                <div class="post_footer">
                    
                    <div class="meta">
                        <div class="info">
              <span class="field tags">
                <i class="remixicon-stack-line"></i>
                
                <a href="/tags/goim/">goim</a>
                  
                <a href="/tags/golang/">golang</a>
                  
              </span>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><span>△</span></a>
</div>
<footer class="footer">
  <div class="powered_by">
    <a href="https://zeuk.me">Designed by Zeuk,</a>
    <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
  </div>

  <div class="footer_slogan">
    <br>
    <br>
    <span>技术.设计.音乐</span>
  </div>
</footer>



<script src="/js/jquery-3.3.1.min.js"></script>
<script src="/js/zozo.js"></script>
<script src="/js/highlight.pack.js"></script>
<link  href="/css/fancybox.min.css" rel="stylesheet">
<script src="/js/fancybox.min.js"></script>

<script>hljs.initHighlightingOnLoad()</script>


  <script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>






</body>
</html>